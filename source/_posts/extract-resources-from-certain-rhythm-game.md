---
title: ğŸ¼ æŸæ¬¾å¿ƒèƒ¸ç‹­çª„çš„å…¬å¸å¼€å‘çš„éŸ³ä¹æ¸¸æˆçš„èµ„æºæå–å°è®°
date: 2023-05-21 18:44:50
tags:
- éŸ³æ¸¸
- é€†å‘
category: æ¸¸æˆ
references:
- title: 'å…­ã€è·å–å¯†é’¥ â€“ UNIâ€™S ON AIRèµ„æºæå–é€†å‘å…¨è®°å½•'
  url: 'http://web.archive.org/web/20220528140408/https://blog.touuki.com/archives/287'
cover: 'https://imgsrc.baidu.com/forum/pic/item/241f95cad1c8a786f57546c32209c93d71cf509b.jpg'
---

æœ€è¿‘è§£åŒ…äº†æŸæ¬¾å¿ƒèƒ¸ç‹­çª„çš„å…¬å¸å¼€å‘çš„éŸ³ä¹æ¸¸æˆï¼Œä»é‡Œé¢æå–å‡ºäº†æ‰€æœ‰æ­Œæ›²çš„æ— æŸéŸ³é¢‘å’Œ BGAã€‚é‚£ä¹ˆåœ¨æ­¤è®°å½•ä¸€ä¸‹è§£åŒ…çš„å¤§è‡´è¿‡ç¨‹ï¼Œå’Œå…¶ä¸­é‡åˆ°çš„å°é—®é¢˜ã€‚

<!--more-->

> âš ï¸ è¯·æ³¨æ„ï¼šæœ¬æ–‡åŠä½œè€…ä¸è¯¥å…¬å¸åŠè¯¥éŸ³ä¹æ¸¸æˆæ²¡æœ‰ä»»ä½•å…³ç³»ã€‚
>
> ä¸‹æ–‡çš„è·¯å¾„åŠä»£ç ä¸­ç”¨ TheGame ä»£æŒ‡è¿™æ¬¾æ¸¸æˆã€‚
>
> å¦‚æœæ‚¨è®¤ä¸ºæ­¤æ–‡ç« ä¾µçŠ¯äº†æ‚¨çš„ç‰ˆæƒï¼Œè¯· [è”ç³»æˆ‘](mailto:ydz@yidaozhan.top) åˆ é™¤ã€‚

### â–¶ï¸ æ¦‚è§ˆ

æˆ‘çš„ç›®çš„æ˜¯æå–æ‰€æœ‰æ­Œæ›²å’Œæ›²ç»˜ï¼Œå¹¶åˆå¹¶æˆå¸¦ä¿¡æ¯çš„ flac æ–‡ä»¶ä»¥æ”¶è—ã€‚

è¿™æ¬¾æ¸¸æˆä½¿ç”¨ Unity å¼•æ“å¼€å‘ï¼Œå…¶ä¸­è§†é¢‘å’ŒéŸ³ä¹æ–‡ä»¶éƒ½ä½¿ç”¨äº† CriWare å¼€å‘çš„å®¹å™¨æ ¼å¼ï¼Œå¹¶ä½¿ç”¨å¯†é’¥åŠ å¯†ï¼Œå›¾ç‰‡æ–‡ä»¶ä½¿ç”¨äº† Unity çš„ assets bundle å®¹å™¨æ ¼å¼ã€‚éœ€è¦ä½¿ç”¨ä¸åŒæ–¹æ³•æå–èµ„æºã€‚

### ğŸ—ƒï¸ 0. å¾—åˆ°èµ„äº§æ–‡ä»¶å¤¹

å¦‚æœä½ æ‹¿åˆ°çš„æ¸¸æˆæ˜¯ vhd æ ¼å¼ï¼Œè¯·å…ˆä½¿ç”¨ `guestmount` å‘½ä»¤è¡Œå·¥å…·æˆ–æ‰“äº†ç‰¹å®šè¡¥ä¸çš„ 7-zip ä»ä¸­æå–å‡ºèµ„äº§æ–‡ä»¶å¤¹ï¼ˆ`TheGame_Data`ï¼‰ã€‚

### ğŸ” 1. è·å– CriWare å¯†é’¥

æ ¹æ® [æ­¤åšæ–‡](http://web.archive.org/web/20220528140408/https://blog.touuki.com/archives/287) çš„ä»‹ç»ï¼Œå¯ä»¥ä½¿ç”¨ Il2cppDumper å’Œ AssetStudio è·å– CriWare å¯†é’¥ã€‚

è¿™æ¬¾æ¸¸æˆçš„ç›®æ ‡å¹³å°æ˜¯ Windowsï¼Œæ²¡æœ‰ä½¿ç”¨ il2cppï¼Œæ‰€ä»¥åªéœ€è¦ä½¿ç”¨ AssetStudio å°±å¯ä»¥è·å¾—å¯†é’¥ã€‚

> Tips: ç”±äºè¯¥æ¸¸æˆèµ„äº§æ–‡ä»¶å¤¹è¿‡å¤§ï¼ˆ40GB+ï¼‰ï¼Œå¯ä»¥å…ˆå¤åˆ¶ä¸€ä»½ä¸å¸¦ `StreamingAssets` çš„èµ„äº§æ–‡ä»¶å¤¹ï¼Œåœ¨ AssetStudio ä¸­è¿›è¡Œæ“ä½œã€‚

å½“ AssetStudio æç¤º Select Assembly Folder æ—¶ï¼Œç›´æ¥é€‰æ‹© Managed æ–‡ä»¶å¤¹å³å¯ã€‚

{%image https://imgsrc.baidu.com/forum/pic/item/55e736d12f2eb9389e59763f90628535e4dd6fc2.jpg æˆåŠŸåœ°å¾—åˆ°äº†å¯†é’¥ï¼ %}

### ğŸµ 2. è§£å¯†å¹¶è½¬æ¢æ­Œæ›²

æ¸¸æˆçš„æ‰€æœ‰éŸ³é¢‘èµ„æºä½äº `TheGame_Data/StreamingAssets/A000/SoundData` æ–‡ä»¶å¤¹ä¸‹ï¼Œä½¿ç”¨ AFS2 (*.acb / *.awb) æ ¼å¼è¿›è¡Œæ‰“åŒ…ã€‚

`Voice` å¼€å¤´çš„ä¸ºç•Œé¢è¯­éŸ³ï¼Œ`Voice_Partner` å¼€å¤´çš„ä¸ºæ—…è¡Œä¼™ä¼´è¯­éŸ³ï¼Œ`music` å¼€å¤´çš„ä¸ºæ­Œæ›²æ–‡ä»¶ï¼Œå‰©ä¸‹çš„æ˜¯ç•Œé¢èƒŒæ™¯éŸ³ä¹ã€‚è¿™é‡Œæˆ‘åªå–æ­Œæ›²ï¼Œå…¶å®ƒéŸ³é¢‘èµ„æºåŒç†ã€‚

ä½¿ç”¨ [CriTools](https://github.com/kohos/CriTools) å°±å¯ä»¥æŠŠè¿™äº›æ­Œæ›²æ–‡ä»¶è½¬æ¢ä¸º wavã€‚

```bash
node index.js acb2wavs '/path/to/SoundData' -k THE_GAME_KEY
```

è½¬æ¢ä¸º wav ä¹‹åï¼Œæˆ‘ä½¿ç”¨äº†ä¸‹é¢å‡ æ¡å‘½ä»¤æ•´ç†æ–‡ä»¶ï¼Œå¹¶è½¬æ¢ä¸º flac æ ¼å¼ã€‚

```bash
for sound in ./SoundData/*; do mv "./SoundData/${sound}/stream_1.wav" "./sound/${sound}.wav"; done
cd sound
for sound in ./*; do ffmpeg -i "${sound}" "${sound/wav/flac}"; done
```

æˆ‘ä»¬å°±å¾—åˆ°äº†ä»¥ `music00XXXX.flac` ä¸ºæ–‡ä»¶åçš„æ­Œæ›²æ–‡ä»¶ã€‚å¯ä»¥ç›´æ¥æ’­æ”¾ï¼Œä¹Ÿä¾¿äºåç»­æ“ä½œã€‚

å…¶ç ç‡ä¸º 1024 Kbit/sï¼Œé‡‡æ ·ç‡ä¸º 44.1 KHzã€‚

### ğŸ–¼ï¸ 3. è½¬æ¢æ›²ç»˜

æ¸¸æˆçš„å›¾åƒèµ„æºä½äº `TheGame_Data/StreamingAssets/A000/AssetBundleImages` æ–‡ä»¶å¤¹ä¸­ã€‚

æ›²ç»˜ä½äº `jacket` æ–‡ä»¶å¤¹ä¸­ã€‚è¿™é‡Œæˆ‘åªå–æ›²ç»˜ï¼Œå…¶å®ƒå›¾åƒèµ„æºåŒç†ã€‚

ä½¿ç”¨ AssetStudio å¯ä»¥ç›´æ¥æŠŠè¿™äº› ab æ–‡ä»¶ä¸­çš„ png å›¾ç‰‡æ–‡ä»¶æå–å‡ºæ¥ã€‚

{%image https://imgsrc.baidu.com/forum/pic/item/71cf3bc79f3df8dc9530835c8811728b461028e9.jpg %}

### â„¹ï¸ 4. ç»™ flac æ·»åŠ æ­Œæ›²ä¿¡æ¯å’Œæ›²ç»˜

æ¸¸æˆçš„æ­Œæ›²ä¿¡æ¯å‚¨å­˜äº `music`ã€`musicVersion`ã€`musicGenre` å‡ ä¸ªæ–‡ä»¶å¤¹ä¸­çš„ XML æ–‡ä»¶ä¸­ã€‚

æˆ‘ç¼–å†™äº†å¦‚ä¸‹çš„ Python è„šæœ¬ä»¥ç»™ flac æ·»åŠ æ­Œæ›²ä¿¡æ¯å’Œæ›²ç»˜ã€‚

```python
#!/usr/bin/env python3

from pathlib import Path
from xml.dom.minidom import parse as parse_xml
from mutagen.flac import FLAC, Picture
import shutil

# å¸¸é‡
MUSIC_VERSION_DIR = Path('./StreamingAssets/A000/musicVersion/') 
MUSIC_GENRE_DIR = Path('./StreamingAssets/A000/musicGenre/') 
MUSIC_DATA_DIR = Path('./StreamingAssets/A000/music/')
SOUND_FLAC_DIR = Path('/home/yidaozhan/sound/')
JACKET_PNG_DIR = Path('/home/yidaozhan/jackets/')
OUTPUT_DIR = Path('/home/yidaozhan/output')

# æ•°æ®
music_version = {}
music_genre = {}
music_data = {}

for dir in MUSIC_VERSION_DIR.iterdir():
    if dir.is_dir():
        document = parse_xml(open(dir / 'MusicVersion.xml')).documentElement
        music_version[document.getElementsByTagName('version')[0].childNodes[0].data] = document.getElementsByTagName('genreName')[0].childNodes[0].data

for dir in MUSIC_GENRE_DIR.iterdir():
    if dir.is_dir():
        document = parse_xml(open(dir / 'MusicGenre.xml')).documentElement
        music_genre[document.getElementsByTagName('name')[0].getElementsByTagName('id')[0].childNodes[0].data] = document.getElementsByTagName('genreName')[0].childNodes[0].data

for dir in MUSIC_DATA_DIR.iterdir():
    if dir.is_dir():
        if (dir / 'Music.xml').exists():
            document = parse_xml(open(dir / 'Music.xml')).documentElement
            id = (document.getElementsByTagName('name')[0].getElementsByTagName('id')[0].childNodes[0].data).zfill(6)[-4:].zfill(6)
            song_name = document.getElementsByTagName('name')[0].getElementsByTagName('str')[0].childNodes[0].data
            artist_name = document.getElementsByTagName('artistName')[0].getElementsByTagName('str')[0].childNodes[0].data
            if 'æ›²ï¼š' in artist_name:
                artist_name = artist_name.replace('æ›²ï¼š', '').replace('ï¼æ­Œï¼š', ' feat. ').split('[')[0]
            # é˜²æ­¢è¶…è¿‡æ–‡ä»¶åå­—ç¬¦ä¸Šé™
            genre_id = document.getElementsByTagName('genreName')[0].getElementsByTagName('id')[0].childNodes[0].data
            version = (document.getElementsByTagName('version')[0].childNodes[0].data)[0:3]+'00'
            music_data[id] = {
                'song': song_name,
                'artist': artist_name,
                'album': music_genre[genre_id] + ' (' + music_version[version] + ')',
            }

for music_file_orig in SOUND_FLAC_DIR.iterdir():
    if music_file_orig.is_file():
        id = music_file_orig.stem[-6:]
        music_file = OUTPUT_DIR / ('Music ' + id[2:] + '.flac')
        # ç•Œé¢æ›²å’ŒæŸäº›æ­Œæ›²æ²¡æœ‰ä¿¡æ¯ï¼Œç›´æ¥å‘½åä¸ºã€ŒMusic 00xx.flacã€
        shutil.copy(
            music_file_orig,
            music_file
        )

        if id in music_data:
            # é‡å‘½åæ­Œæ›²
            new_filename = music_data[id]['artist'] + ' - ' + music_data[id]['song'] + '.flac'
            # åˆ é™¤ä¸å…¼å®¹çš„å­—ç¬¦
            new_filename = new_filename.replace('/', 'ï¼').replace('\\', 'ï¼¼').replace(':', 'ï¼š').replace('*', 'ï¼Š').replace('?', 'ï¼Ÿ').replace('"', 'ï¼‚').replace('<', 'ï¼œ').replace('>', 'ï¼').replace('|', 'ï½œ')
            if 'CV.' in new_filename:
                new_filename = new_filename.split('ï¼CV')[0]
            music_file.rename(
                OUTPUT_DIR / new_filename
                )
            music_file = OUTPUT_DIR / new_filename

        if id in music_data:
            # æ·»åŠ å¤´éƒ¨ä¿¡æ¯
            audio_file = FLAC(music_file)
            audio_file['title'] = music_data[id]['song']
            audio_file['artist'] = music_data[id]['artist']
            audio_file['album'] = music_data[id]['album']
            audio_file['albumartist'] = music_data[id]['artist']
            audio_file.save()
        
        jacket_file = JACKET_PNG_DIR / f'UI_Jacket_{id}.png'
        if jacket_file.exists():
            # æ·»åŠ æ›²ç»˜
            picture = Picture()
            picture.type = 3
            picture.mime = 'image/png'
            if id in music_data:
                picture.desc = music_data[id]['song']
            picture.data = open(jacket_file, 'rb').read()
            audio_file.add_picture(picture)
            audio_file.save()
```

### ğŸ¤— 5. æˆæœ

æå–æˆåŠŸï¼

{%image https://imgsrc.baidu.com/forum/pic/item/f703738da9773912392489acbd198618377ae2f9.jpg %}

ä½ å¯ä»¥åœ¨ä¸€åˆ€æ–©ã®å°çªçš„ Telegram é¢‘é“ä¸­è·å–è¿™äº›æ­Œæ›²ã€‚

### ğŸ“½ï¸ 6. è§£å¯†å¹¶è½¬æ¢ BGA

æ¸¸æˆçš„ BGA ä½¿ç”¨ CriWare çš„ USM æ ¼å¼åŠ å¯†ï¼Œä½äº `TheGame_Data/StreamingAssets/A000/MovieData` ä¸­ã€‚

ä½¿ç”¨ [WannaCRI](https://github.com/donmai-me/WannaCRI) å·¥å…·å¯ä»¥æŠŠè¿™äº› USM æ–‡ä»¶ (åç¼€åå®é™…ä¸Šä¸º dat) è½¬æ¢ä¸º ivf æ ¼å¼è§†é¢‘ã€‚

```bash
python -m wannacri extractusm ./StreamingAssets/A000/MovieData -k THE_GAME_KEY
```

ä¹‹åå°±å¯ä»¥ä½¿ç”¨ ffmeg å°†å…¶è½¬æ¢ä¸º mp4 äº†ã€‚å…¶åˆ†è¾¨ç‡ä¸º 1080*650ï¼Œå¸§ç‡ä¸º 30 FPSï¼Œç ç‡ä¸º 2 Mbit/sã€‚

è½¬æ¢ BGA æå…¶åƒ CPUï¼Œé€Ÿåº¦ä¹Ÿå¾ˆæ…¢ï¼Œå¹¶ä¸”å¤§éƒ¨åˆ† BGA éƒ½å¯ä»¥åœ¨è§†é¢‘ç½‘ç«™ä¸Šæ‰¾åˆ°ã€‚è¿™æ˜¯ä¸ªåƒåŠ›ä¸è®¨å¥½çš„å·¥ä½œï¼Œæ‰€ä»¥æˆ‘å¹¶æ²¡æœ‰è½¬æ¢ï¼Œåªæ˜¯å°†æ–¹æ³•å†™åœ¨è¿™é‡Œã€‚æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±è½¬æ¢è¯•è¯•ã€‚
